<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…å†æ€»ç»“åŠŸèƒ½éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        .test-btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-btn:hover { background: #0056b3; }
        .test-btn.success { background: #28a745; }
        .test-btn.danger { background: #dc3545; }
        .result { margin: 15px 0; padding: 15px; border-radius: 5px; min-height: 50px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px; width: 200px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .summary-display { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ ç—…å†æ€»ç»“åŠŸèƒ½éªŒè¯</h1>
        
        <!-- æµ‹è¯•é…ç½® -->
        <div class="test-section">
            <h3>æµ‹è¯•é…ç½®</h3>
            <label>visitId: </label>
            <input type="text" id="testVisitId" value="visit_001" placeholder="è¾“å…¥visitId">
            <button class="test-btn" onclick="setRandomVisitId()">éšæœºç”Ÿæˆ</button>
        </div>

        <!-- æ­¥éª¤1ï¼šå‡†å¤‡æµ‹è¯•æ•°æ® -->
        <div class="test-section">
            <h3>æ­¥éª¤1ï¼šå‡†å¤‡æµ‹è¯•æ•°æ®</h3>
            <p>åˆ›å»ºæµ‹è¯•ç”¨çš„è½¬å½•è®°å½•å’Œç—…å†æ€»ç»“æ•°æ®</p>
            <button class="test-btn" onclick="createTestTranscript()">åˆ›å»ºæµ‹è¯•è½¬å½•</button>
            <button class="test-btn" onclick="createTestSummary()">åˆ›å»ºæµ‹è¯•ç—…å†æ€»ç»“</button>
            <button class="test-btn danger" onclick="cleanupTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
            <div id="step1-result" class="result info">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <!-- æ­¥éª¤2ï¼šæµ‹è¯•è·å–ç—…å†æ€»ç»“ -->
        <div class="test-section">
            <h3>æ­¥éª¤2ï¼šæµ‹è¯•è·å–ç—…å†æ€»ç»“</h3>
            <p>æµ‹è¯•ä»æ•°æ®åº“è·å–å·²ä¿å­˜çš„ç—…å†æ€»ç»“</p>
            <button class="test-btn" onclick="getSummary()">è·å–ç—…å†æ€»ç»“</button>
            <button class="test-btn" onclick="checkSummaryExists()">æ£€æŸ¥æ˜¯å¦å­˜åœ¨</button>
            <div id="step2-result" class="result info">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <!-- æ­¥éª¤3ï¼šæµ‹è¯•ç”Ÿæˆç—…å†æ€»ç»“ -->
        <div class="test-section">
            <h3>æ­¥éª¤3ï¼šæµ‹è¯•ç”Ÿæˆç—…å†æ€»ç»“ï¼ˆæµå¼ï¼‰</h3>
            <p>æµ‹è¯•é€šè¿‡è½¬å½•æ–‡æœ¬ç”Ÿæˆæ–°çš„ç—…å†æ€»ç»“</p>
            <button class="test-btn" onclick="generateSummary()">ç”Ÿæˆç—…å†æ€»ç»“</button>
            <div id="step3-result" class="result info">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <!-- æ­¥éª¤4ï¼šæŸ¥çœ‹æ‰€æœ‰æ•°æ® -->
        <div class="test-section">
            <h3>æ­¥éª¤4ï¼šæŸ¥çœ‹æ‰€æœ‰æ•°æ®ï¼ˆè°ƒè¯•ï¼‰</h3>
            <p>æŸ¥çœ‹æ•°æ®åº“ä¸­çš„æ‰€æœ‰ç—…å†æ€»ç»“å’Œè½¬å½•è®°å½•</p>
            <button class="test-btn" onclick="viewAllSummaries()">æŸ¥çœ‹æ‰€æœ‰ç—…å†æ€»ç»“</button>
            <button class="test-btn" onclick="viewAllTranscripts()">æŸ¥çœ‹æ‰€æœ‰è½¬å½•è®°å½•</button>
            <div id="step4-result" class="result info">ç­‰å¾…æŸ¥çœ‹...</div>
        </div>
    </div>

    <script>
        // è®¾ç½®éšæœºvisitId
        function setRandomVisitId() {
            const randomId = 'test_visit_' + Date.now();
            document.getElementById('testVisitId').value = randomId;
        }

        // è·å–å½“å‰visitId
        function getCurrentVisitId() {
            return document.getElementById('testVisitId').value || 'visit_001';
        }

        // åˆ›å»ºæµ‹è¯•è½¬å½•è®°å½•
        async function createTestTranscript() {
            const resultDiv = document.getElementById('step1-result');
            const visitId = getCurrentVisitId();
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨åˆ›å»ºæµ‹è¯•è½¬å½•è®°å½•...';

            try {
                const response = await fetch(`/api/test/create-test-transcript?visitId=${encodeURIComponent(visitId)}`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… ${data.message}<br>transcriptId: ${data.transcriptId}`;
                } else if (data.status === 'EXISTS') {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = `âš ï¸ ${data.message}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ åˆ›å»ºå¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // åˆ›å»ºæµ‹è¯•ç—…å†æ€»ç»“
        async function createTestSummary() {
            const resultDiv = document.getElementById('step1-result');
            const visitId = getCurrentVisitId();
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨åˆ›å»ºæµ‹è¯•ç—…å†æ€»ç»“...';

            try {
                const response = await fetch(`/api/test/create-test-summary?visitId=${encodeURIComponent(visitId)}`, {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… ${data.message}<br>summaryId: ${data.summaryId}`;
                } else if (data.status === 'EXISTS') {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = `âš ï¸ ${data.message}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ åˆ›å»ºå¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // æ¸…ç†æµ‹è¯•æ•°æ®
        async function cleanupTestData() {
            const resultDiv = document.getElementById('step1-result');
            const visitId = getCurrentVisitId();
            
            if (!confirm(`ç¡®å®šè¦æ¸…ç†visitId=${visitId}çš„æµ‹è¯•æ•°æ®å—ï¼Ÿ`)) {
                return;
            }
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸…ç†æµ‹è¯•æ•°æ®...';

            try {
                const response = await fetch(`/api/test/cleanup/${encodeURIComponent(visitId)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… ${data.message}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ æ¸…ç†å¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // è·å–ç—…å†æ€»ç»“
        async function getSummary() {
            const resultDiv = document.getElementById('step2-result');
            const visitId = getCurrentVisitId();
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è·å–ç—…å†æ€»ç»“...';

            try {
                const response = await fetch(`/api/medical-summary/visit/${encodeURIComponent(visitId)}`);

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    
                    const summaryHtml = `
                        <strong>âœ… è·å–æˆåŠŸï¼</strong><br>
                        <strong>summaryId:</strong> ${data.summaryId}<br>
                        <strong>visitId:</strong> ${data.visitId}<br>
                        <strong>doctorId:</strong> ${data.doctorId}<br>
                        <strong>patientId:</strong> ${data.patientId}<br>
                        <strong>åˆ›å»ºæ—¶é—´:</strong> ${data.createdAt}<br><br>
                        <div class="summary-display">
ç—…å†æ€»ç»“
==========
ç—‡çŠ¶è¯¦æƒ…ï¼š
${data.symptomDetails}

ç”Ÿå‘½ä½“å¾ï¼š
${data.vitalSigns}

æ—¢å¾€ç—…å²ï¼š
${data.pastMedicalHistory}

å½“å‰ç”¨è¯ï¼š
${data.currentMedications}
                        </div>
                    `;
                    
                    resultDiv.innerHTML = summaryHtml;
                } else if (response.status === 404) {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = 'âš ï¸ æœªæ‰¾åˆ°ç—…å†æ€»ç»“ï¼Œè¯·å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®æˆ–ç”Ÿæˆç—…å†æ€»ç»“';
                } else {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ è·å–å¤±è´¥: HTTP ${response.status} - ${errorText}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // æ£€æŸ¥ç—…å†æ€»ç»“æ˜¯å¦å­˜åœ¨
        async function checkSummaryExists() {
            const resultDiv = document.getElementById('step2-result');
            const visitId = getCurrentVisitId();
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ£€æŸ¥ç—…å†æ€»ç»“...';

            try {
                const response = await fetch(`/api/medical-summary/visit/${encodeURIComponent(visitId)}`);

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… ç—…å†æ€»ç»“å­˜åœ¨<br>summaryId: ${data.summaryId}<br>åˆ›å»ºæ—¶é—´: ${data.createdAt}`;
                } else if (response.status === 404) {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = 'âš ï¸ ç—…å†æ€»ç»“ä¸å­˜åœ¨';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ æ£€æŸ¥å¤±è´¥: HTTP ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // ç”Ÿæˆç—…å†æ€»ç»“
        async function generateSummary() {
            const resultDiv = document.getElementById('step3-result');
            const visitId = getCurrentVisitId();
            const doctorId = 'test_doctor_001';
            const patientId = 'test_patient_001';
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ç”Ÿæˆç—…å†æ€»ç»“...';

            try {
                const url = `/api/medical-summary/generate/${encodeURIComponent(visitId)}?doctorId=${encodeURIComponent(doctorId)}&patientId=${encodeURIComponent(patientId)}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'text/event-stream',
                        'Cache-Control': 'no-cache'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let summaryContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));

                                if (data.event === 'completed') {
                                    resultDiv.className = 'result success';
                                    resultDiv.innerHTML = `
                                        <strong>âœ… ç—…å†æ€»ç»“ç”Ÿæˆå®Œæˆ</strong><br>
                                        <div class="summary-display">${summaryContent}</div>
                                    `;
                                    return;
                                } else if (data.event === 'error') {
                                    resultDiv.className = 'result error';
                                    resultDiv.innerHTML = `âŒ ç”Ÿæˆå¤±è´¥: ${data.message}`;
                                    return;
                                } else if (data.event === 'message' && data.content) {
                                    summaryContent += data.content;
                                    resultDiv.innerHTML = `ğŸ”„ æ­£åœ¨ç”Ÿæˆ...<br><div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-wrap;">${summaryContent}</div>`;
                                }
                            } catch (e) {
                                console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('ç”Ÿæˆç—…å†æ€»ç»“å¤±è´¥:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
            }
        }

        // æŸ¥çœ‹æ‰€æœ‰ç—…å†æ€»ç»“
        async function viewAllSummaries() {
            const resultDiv = document.getElementById('step4-result');
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è·å–æ‰€æœ‰ç—…å†æ€»ç»“...';

            try {
                const response = await fetch('/api/test/summaries');

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    
                    if (data.length === 0) {
                        resultDiv.innerHTML = 'ğŸ“‹ æ•°æ®åº“ä¸­æ²¡æœ‰ç—…å†æ€»ç»“è®°å½•';
                    } else {
                        let html = `<strong>ğŸ“‹ æ‰¾åˆ° ${data.length} æ¡ç—…å†æ€»ç»“è®°å½•ï¼š</strong><br><br>`;
                        data.forEach((summary, index) => {
                            html += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; background: white;">
                                    <strong>${index + 1}. visitId: ${summary.visitId}</strong><br>
                                    summaryId: ${summary.summaryId}<br>
                                    doctorId: ${summary.doctorId}<br>
                                    patientId: ${summary.patientId}<br>
                                    åˆ›å»ºæ—¶é—´: ${summary.createdAt}<br>
                                    <details style="margin-top: 5px;">
                                        <summary>æŸ¥çœ‹è¯¦æƒ…</summary>
                                        <pre style="font-size: 11px; max-height: 150px; overflow-y: auto;">ç—‡çŠ¶è¯¦æƒ…: ${summary.symptomDetails}
ç”Ÿå‘½ä½“å¾: ${summary.vitalSigns}
æ—¢å¾€ç—…å²: ${summary.pastMedicalHistory}
å½“å‰ç”¨è¯: ${summary.currentMedications}</pre>
                                    </details>
                                </div>
                            `;
                        });
                        resultDiv.innerHTML = html;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ è·å–å¤±è´¥: HTTP ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // æŸ¥çœ‹æ‰€æœ‰è½¬å½•è®°å½•
        async function viewAllTranscripts() {
            const resultDiv = document.getElementById('step4-result');
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è·å–æ‰€æœ‰è½¬å½•è®°å½•...';

            try {
                const response = await fetch('/api/test/transcripts');

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    
                    if (data.length === 0) {
                        resultDiv.innerHTML = 'ğŸ“‹ æ•°æ®åº“ä¸­æ²¡æœ‰è½¬å½•è®°å½•';
                    } else {
                        let html = `<strong>ğŸ“‹ æ‰¾åˆ° ${data.length} æ¡è½¬å½•è®°å½•ï¼š</strong><br><br>`;
                        data.forEach((transcript, index) => {
                            html += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; background: white;">
                                    <strong>${index + 1}. visitId: ${transcript.visitId}</strong><br>
                                    transcriptId: ${transcript.transcriptId}<br>
                                    çŠ¶æ€: ${transcript.status}<br>
                                    éŸ³é¢‘æ—¶é•¿: ${transcript.audioDuration}ç§’<br>
                                    éŸ³é¢‘æ ¼å¼: ${transcript.audioFormat}<br>
                                    åˆ›å»ºæ—¶é—´: ${transcript.createdAt}<br>
                                    <details style="margin-top: 5px;">
                                        <summary>æŸ¥çœ‹è½¬å½•æ–‡æœ¬</summary>
                                        <pre style="font-size: 11px; max-height: 150px; overflow-y: auto;">${transcript.transcriptText}</pre>
                                    </details>
                                </div>
                            `;
                        });
                        resultDiv.innerHTML = html;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ è·å–å¤±è´¥: HTTP ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }
    </script>
</body>
</html>