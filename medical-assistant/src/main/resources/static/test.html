<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½åŒ»ç–—åŠ©æ‰‹ - è¯­éŸ³è½¬å½•æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 800px;
      width: 100%;
    }

    h1 {
      -align: center;
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .control-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .record-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    : 0 4px 15px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
    }

    .record-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .record-button:active {
      transform: scale(0.95);
    }

    .record-button.recording {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
      }
      50% {
        box-shadow: 0 4px 30px rgba(245, 87, 108, 0.8);
      }
    }

    .record-button .icon {
      font-size: 40px;
      display: block;
      margin-bottom: 5px;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      width: 100%;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #6c757d;
      transition: background 0.3s ease;
    }

    .status-indicator.ready {
      background: #28a745;
    }

    .status-indicator.recording {
      background: #dc3545;
      animation: blink 1s infinite;
    }

    .status-indicator.processing {
      background: #ffc107;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .status-text {
      color: #495057;
      font-weight: 500;
      font-size: 14px;
    }

    .timer {
      color: #6c757d;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin-left: auto;
    }

    .settings-panel {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .settings-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .setting-item {
      flex: 1;
      min-width: 200px;
    }

    .setting-item label {
      display: block;
      color: #495057;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .setting-item input,
    .setting-item select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .setting-item input:focus,
    .setting-item select:focus {
      outline: none;
      border-color: #667eea;
    }

    .result-panel {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      min-height: 200px;
      margin-bottom: 20px;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .result-title {
      color: #495057;
      font-weight: 600;
      font-size: 16px;
    }

    .copy-button {
      padding: 6px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s ease;
    }

    .copy-button:hover {
      background: #5568d3;
    }

    .result-content {
      background: white;
      border-radius: 8px;
      padding: 15px;
      min-height: 150px;
      color: #212529;
      line-height: 1.8;
      font-size: 15px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .result-content.empty {
      color: #adb5bd;
      font-style: italic;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .history-panel {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
    }

    .history-title {
      color: #495057;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 15px;
    }

    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 4px solid #667eea;
    }

    .history-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-item-time {
      color: #6c757d;
      font-size: 12px;
    }

    .history-item-status {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .history-item-status.completed {
      background: #d4edda;
      color: #155724;
    }

    .history-item-status.processing {
      background: #fff3cd;
      color: #856404;
    }

    .history-item-status.failed {
      background: #f8d7da;
      color: #721c24;
    }

    .history-item-text {
      color: #495057;
      font-size: 14px;
      line-height: 1.6;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .audio-visualizer {
      width: 100%;
      height: 60px;
      background: white;
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      padding: 10px;
    }

    .audio-bar {
      width: 4px;
      background: #667eea;
      border-radius: 2px;
      transition: height 0.1s ease;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #f5c6cb;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(102, 126, 234, 0.3);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    .history-list::-webkit-scrollbar {
      width: 6px;
    }

    .history-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 3px;
    }

    .history-list::-webkit-scrollbar-thumb:hover {
      background: #5568d3;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 24px;
      }

      .settings-row {
        flex-direction: column;
      }

      .setting-item {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ¥ æ™ºèƒ½åŒ»ç–—åŠ©æ‰‹</h1>
  <p class="subtitle">è¯­éŸ³è½¬å½•æµ‹è¯•ç³»ç»Ÿ</p>

  <!-- é”™è¯¯æç¤º -->
  <div id="errorMessage" class="error-message"></div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-panel">
    <div class="settings-row">
      <div class="setting-item">
        <label for="userId">ç”¨æˆ·ID</label>
        <input type="text" id="userId" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID" value="test_user_001">
      </div>
      <div class="setting-item">
        <label for="language">è¯­è¨€æ¨¡å¼</label>
        <select id="language">
          <option value="autodialect">ä¸­è‹±+æ–¹è¨€è¯†åˆ«</option>
          <option value="autominor">37è¯­ç§è¯†åˆ«</option>
        </select>
      </div>
      <div class="setting-item">
        <label for="domain">é¢†åŸŸä¼˜åŒ–</label>
        <select id="domain">
          <option value="">æ— </option>
          <option value="medical" selected>åŒ»ç–—</option>
          <option value="finance">é‡‘è</option>
          <option value="court">æ³•å¾‹</option>
          <option value="edu">æ•™è‚²</option>
        </select>
      </div>
    </div>
  </div>

  <!-- æ§åˆ¶é¢æ¿ -->
  <div class="control-panel">
    <button id="recordButton" class="record-button">
      <span class="icon">ğŸ¤</span>
      <span class="text">å¼€å§‹å½•éŸ³</span>
    </button>

    <div class="status-bar">
      <div id="statusIndicator" class="status-indicator ready"></div>
      <span id="statusText" class="status-text">å‡†å¤‡å°±ç»ª</span>
      <span id="timer" class="timer">00:00</span>
    </div>

    <!-- éŸ³é¢‘å¯è§†åŒ– -->
    <div id="audioVisualizer" class="audio-visualizer" style="display: none;">
      <!-- åŠ¨æ€ç”ŸæˆéŸ³é¢‘æ¡ -->
    </div>
  </div>

  <!-- ç»“æœé¢æ¿ -->
  <div class="result-panel">
    <div class="result-header">
      <span class="result-title">è½¬å½•ç»“æœ</span>
      <button id="copyButton" class="copy-button">ğŸ“‹ å¤åˆ¶</button>
    </div>
    <div id="resultContent" class="result-content empty">
      ç‚¹å‡»"å¼€å§‹å½•éŸ³"æŒ‰é’®å¼€å§‹è¯­éŸ³è½¬å½•...
    </div>
  </div>

  <!-- å†å²è®°å½•é¢æ¿ -->
  <div class="history-panel">
    <div class="history-title">ğŸ“ å†å²è®°å½•</div>
    <div id="historyList" class="history-list">
      <!-- åŠ¨æ€ç”Ÿæˆå†å²è®°å½• -->
    </div>
  </div>
</div>

<!-- å…³é”®ä¿®æ”¹ï¼šå°†JSä»£ç ç§»åˆ°HTMLç»“æ„åé¢ï¼Œç¡®ä¿DOMå…ƒç´ å…ˆåŠ è½½ -->
<script>
  // å…¨å±€å˜é‡
  let isRecording = false;
  let mediaRecorder = null;
  let audioChunks = [];
  let startTime = null;
  let timerInterval = null;
  let sessionId = null;
  let audioContext = null;
  let analyser = null;
  let visualizerInterval = null;
  let audioProcessor = null;

  // DOM å…ƒç´  - åœ¨é¡µé¢åŠ è½½åæ‰è·å–
  let recordButton, statusIndicator, statusText, timer, resultContent, copyButton, historyList, errorMessage, audioVisualizer;

  // åˆå§‹åŒ– - ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†æ‰§è¡Œ
  document.addEventListener('DOMContentLoaded', () => {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

    // è·å–DOMå…ƒç´  - åªæœ‰åœ¨DOMå®Œå…¨åŠ è½½åæ‰èƒ½è·å–åˆ°
    recordButton = document.getElementById('recordButton');
    statusIndicator = document.getElementById('statusIndicator');
    statusText = document.getElementById('statusText');
    timer = document.getElementById('timer');
    resultContent = document.getElementById('resultContent');
    copyButton = document.getElementById('copyButton');
    historyList = document.getElementById('historyList');
    errorMessage = document.getElementById('errorMessage');
    audioVisualizer = document.getElementById('audioVisualizer');

    // æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!recordButton) {
      console.error('é”™è¯¯ï¼šæœªæ‰¾åˆ°recordButtonå…ƒç´ ');
      showError('é¡µé¢é…ç½®é”™è¯¯ï¼šæœªæ‰¾åˆ°å½•éŸ³æŒ‰é’®');
      return;
    }

    if (!audioVisualizer) {
      console.error('è­¦å‘Šï¼šæœªæ‰¾åˆ°audioVisualizerå…ƒç´ ');
    }

    if (!resultContent) {
      console.error('é”™è¯¯ï¼šæœªæ‰¾åˆ°resultContentå…ƒç´ ');
      showError('é¡µé¢é…ç½®é”™è¯¯ï¼šæœªæ‰¾åˆ°ç»“æœæ˜¾ç¤ºåŒºåŸŸ');
      return;
    }

    console.log('æ‰€æœ‰DOMå…ƒç´ è·å–æˆåŠŸ');

    // åˆå§‹åŒ–å„ç»„ä»¶
    initAudioVisualizer();
    loadHistory();
    checkMicrophonePermission();
    setupEventListeners();
  });

  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    // å½•éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    recordButton.addEventListener('click', async () => {
      if (!isRecording) {
        await startRecording();
      } else {
        await stopRecording();
      }
    });

    // å¤åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    copyButton.addEventListener('click', () => {
      const text = resultContent.textContent;
      if (text && !resultContent.classList.contains('empty')) {
        navigator.clipboard.writeText(text).then(() => {
          copyButton.textContent = 'âœ… å·²å¤åˆ¶';
          setTimeout(() => {
            copyButton.textContent = 'ğŸ“‹ å¤åˆ¶';
          }, 2000);
        }).catch(err => {
          showError('å¤åˆ¶å¤±è´¥: ' + err.message);
        });
      }
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
        e.preventDefault();
        recordButton.click();
      }
    });
  }

  // æ£€æŸ¥éº¦å…‹é£æƒé™
  async function checkMicrophonePermission() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          sampleRate: 16000,
          channelCount: 1,
          echoCancellation: true,
          noiseSuppression: true
        }
      });
      stream.getTracks().forEach(track => track.stop());
      updateStatus('ready', 'å‡†å¤‡å°±ç»ª');
    } catch (error) {
      showError('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®');
      updateStatus('error', 'éº¦å…‹é£æƒé™è¢«æ‹’ç»');
    }
  }

  // å¼€å§‹å½•éŸ³
  async function startRecording() {
    try {
      hideError();

      // è·å–éŸ³é¢‘æµ
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          channelCount: 1,
          sampleRate: 16000,
          sampleSize: 16,
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: false
        }
      });

      // è®¾ç½®éŸ³é¢‘ä¸Šä¸‹æ–‡
      audioContext = new (window.AudioContext || window.webkitAudioContext)({
        sampleRate: 16000
      });

      const source = audioContext.createMediaStreamSource(stream);

      // åˆ›å»ºè„šæœ¬å¤„ç†å™¨æ¥è·å–åŸå§‹PCMæ•°æ®
      audioProcessor = audioContext.createScriptProcessor(4096, 1, 1);

      // é‡ç½®éŸ³é¢‘æ•°æ®
      audioChunks = [];

      // å¤„ç†éŸ³é¢‘æ•°æ®
      audioProcessor.onaudioprocess = (event) => {
        if (!isRecording) return;

        const inputData = event.inputBuffer.getChannelData(0);
        const pcmData = convertFloat32ToInt16(inputData);
        audioChunks.push(pcmData);
      };

      // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
      source.connect(audioProcessor);
      audioProcessor.connect(audioContext.destination);

      // å¼€å§‹å¤„ç†
      isRecording = true;

      // æ›´æ–°UI
      recordButton.classList.add('recording');
      recordButton.querySelector('.icon').textContent = 'â¹ï¸';
      recordButton.querySelector('.text').textContent = 'åœæ­¢å½•éŸ³';
      updateStatus('recording', 'æ­£åœ¨å½•éŸ³...');

      // å¯åŠ¨è®¡æ—¶å™¨
      startTimer();

      // å¯åŠ¨éŸ³é¢‘å¯è§†åŒ–
      setupAudioVisualization(stream);

      console.log('å¼€å§‹å½•éŸ³ - PCMæ ¼å¼');

    } catch (error) {
      console.error('å¯åŠ¨å½•éŸ³å¤±è´¥:', error);
      showError('å¯åŠ¨å½•éŸ³å¤±è´¥: ' + error.message);
      updateStatus('error', 'å½•éŸ³å¤±è´¥');
    }
  }

  // åœæ­¢å½•éŸ³
  async function stopRecording() {
    if (isRecording) {
      isRecording = false;

      // åœæ­¢éŸ³é¢‘å¤„ç†
      if (audioProcessor) {
        audioProcessor.disconnect();
        audioProcessor = null;
      }

      if (audioContext) {
        await audioContext.close();
        audioContext = null;
      }

      // æ›´æ–°UI
      recordButton.classList.remove('recording');
      recordButton.querySelector('.icon').textContent = 'ğŸ¤';
      recordButton.querySelector('.text').textContent = 'å¼€å§‹å½•éŸ³';
      updateStatus('processing', 'å¤„ç†ä¸­...');

      // åœæ­¢è®¡æ—¶å™¨
      stopTimer();

      // åœæ­¢éŸ³é¢‘å¯è§†åŒ–
      stopAudioVisualization();

      // å¤„ç†å½•åˆ¶çš„éŸ³é¢‘æ•°æ®
      await processRecordedAudio();

      console.log('åœæ­¢å½•éŸ³');
    }
  }

  // å¤„ç†å½•åˆ¶çš„éŸ³é¢‘æ•°æ®
  async function processRecordedAudio() {
    try {
      if (audioChunks.length === 0) {
        throw new Error('æ²¡æœ‰å½•åˆ¶åˆ°éŸ³é¢‘æ•°æ®');
      }

      // åˆå¹¶æ‰€æœ‰PCMæ•°æ®å—
      const totalLength = audioChunks.reduce((sum, chunk) => sum + chunk.length, 0);
      const mergedData = new Int16Array(totalLength);

      let offset = 0;
      for (const chunk of audioChunks) {
        mergedData.set(chunk, offset);
        offset += chunk.length;
      }

      // åˆ›å»ºPCMæ ¼å¼çš„Blob
      const pcmBlob = new Blob([mergedData.buffer], {
        type: 'audio/pcm'
      });

      await sendAudioToServer(pcmBlob, mergedData.length);

    } catch (error) {
      console.error('å¤„ç†éŸ³é¢‘æ•°æ®å¤±è´¥:', error);
      showError('å¤„ç†éŸ³é¢‘å¤±è´¥: ' + error.message);
      updateStatus('error', 'å¤„ç†å¤±è´¥');
      resultContent.classList.add('empty');
      resultContent.textContent = 'å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•';
    }
  }

  // å‘é€éŸ³é¢‘åˆ°æœåŠ¡å™¨
  async function sendAudioToServer(audioBlob, dataLength) {
    try {
      updateStatus('processing', 'æ­£åœ¨è½¬å½•...');
      resultContent.classList.add('empty');
      resultContent.innerHTML = '<div class="loading"></div> æ­£åœ¨å¤„ç†éŸ³é¢‘...';

      const formData = new FormData();

      // å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨æ­£ç¡®çš„MIMEç±»å‹å’Œæ–‡ä»¶æ‰©å±•å
      formData.append('file', audioBlob, 'recording.pcm');
      formData.append('userId', document.getElementById('userId').value);
      formData.append('audioEncode', 'pcm_s16le');
      formData.append('sampleRate', '16000');
      formData.append('lang', document.getElementById('language').value);

      // è®¡ç®—éŸ³é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
      const duration = Math.round(dataLength / 16000);
      formData.append('audioDuration', duration.toString());

      const domain = document.getElementById('domain').value;
      if (domain) {
        formData.append('pd', domain);
      }

      console.log('å‘é€éŸ³é¢‘æ•°æ®:', {
        size: audioBlob.size,
        duration: duration + 'ç§’',
        format: 'PCM',
        sampleRate: '16kHz'
      });

      const response = await fetch('/api/transcription/upload', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const result = await response.json();

      if (result.success || result.status === 'SUCCESS') {
        displayResult(result.transcriptionText);
        addToHistory(result);
        updateStatus('ready', 'è½¬å½•å®Œæˆ');
      } else {
        throw new Error(result.message || result.errorMessage || 'è½¬å½•å¤±è´¥');
      }

    } catch (error) {
      console.error('å‘é€éŸ³é¢‘å¤±è´¥:', error);
      showError('è½¬å½•å¤±è´¥: ' + error.message);
      updateStatus('error', 'è½¬å½•å¤±è´¥');
      resultContent.classList.add('empty');
      resultContent.textContent = 'è½¬å½•å¤±è´¥: ' + error.message;
    }
  }

  // å·¥å…·å‡½æ•°ï¼šå°†Float32è½¬æ¢ä¸ºInt16 PCM
  function convertFloat32ToInt16(buffer) {
    const length = buffer.length;
    const pcm = new Int16Array(length);
    for (let i = 0; i < length; i++) {
      const s = Math.max(-1, Math.min(1, buffer[i]));
      pcm[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }
    return pcm;
  }

  // æ˜¾ç¤ºè½¬å½•ç»“æœ
  function displayResult(text) {
    resultContent.classList.remove('empty');
    resultContent.textContent = text || '(æ— å†…å®¹)';
  }

  // æ›´æ–°çŠ¶æ€
  function updateStatus(status, text) {
    if (statusIndicator && statusText) {
      statusIndicator.className = `status-indicator ${status}`;
      statusText.textContent = text;
    }
  }

  // è®¡æ—¶å™¨
  function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');
      if (timer) {
        timer.textContent = `${minutes}:${seconds}`;
      }
    }, 1000);
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  // éŸ³é¢‘å¯è§†åŒ–
  function initAudioVisualizer() {
    if (!audioVisualizer) {
      console.warn('audioVisualizerå…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–');
      return;
    }

    // æ¸…ç©ºç°æœ‰å†…å®¹
    audioVisualizer.innerHTML = '';

    for (let i = 0; i < 40; i++) {
      const bar = document.createElement('div');
      bar.className = 'audio-bar';
      bar.style.height = '5px';
      audioVisualizer.appendChild(bar);
    }
  }

  function setupAudioVisualization(stream) {
    if (!audioVisualizer) return;

    const vizContext = new (window.AudioContext || window.webkitAudioContext)();
    const vizAnalyser = vizContext.createAnalyser();
    const source = vizContext.createMediaStreamSource(stream);
    source.connect(vizAnalyser);
    vizAnalyser.fftSize = 256;

    const bufferLength = vizAnalyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    audioVisualizer.style.display = 'flex';

    visualizerInterval = setInterval(() => {
      if (!isRecording) return;

      vizAnalyser.getByteFrequencyData(dataArray);
      const bars = audioVisualizer.querySelectorAll('.audio-bar');

      bars.forEach((bar, index) => {
        const value = dataArray[Math.floor(index * bufferLength / bars.length)];
        const height = Math.max(5, (value / 255) * 50);
        bar.style.height = height + 'px';
      });
    }, 50);
  }

  function stopAudioVisualization() {
    if (visualizerInterval) {
      clearInterval(visualizerInterval);
      visualizerInterval = null;
    }
    if (audioVisualizer) {
      audioVisualizer.style.display = 'none';
    }
  }

  // å†å²è®°å½•åŠŸèƒ½
  function addToHistory(result) {
    const history = getHistory();
    const record = {
      sessionId: result.sessionId || Date.now().toString(),
      text: result.transcriptionText,
      status: result.status || (result.success ? 'SUCCESS' : 'FAILED'),
      timestamp: new Date().toISOString(),
      userId: document.getElementById('userId').value
    };
    history.unshift(record);

    if (history.length > 20) {
      history.splice(20);
    }

    localStorage.setItem('transcriptionHistory', JSON.stringify(history));
    renderHistory();
  }

  function getHistory() {
    const history = localStorage.getItem('transcriptionHistory');
    return history ? JSON.parse(history) : [];
  }

  function loadHistory() {
    renderHistory();
  }

  function renderHistory() {
    if (!historyList) return;

    const history = getHistory();

    if (history.length === 0) {
      historyList.innerHTML = '<div style="text-align: center; color: #adb5bd; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
      return;
    }

    historyList.innerHTML = history.map(record => {
      const date = new Date(record.timestamp);
      const timeStr = date.toLocaleString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      const statusClass = record.status === 'SUCCESS' ? 'completed' :
              record.status === 'PROCESSING' ? 'processing' : 'failed';
      const statusText = record.status === 'SUCCESS' ? 'å·²å®Œæˆ' :
              record.status === 'PROCESSING' ? 'å¤„ç†ä¸­' : 'å¤±è´¥';

      return `
                    <div class="history-item" onclick="showHistoryDetail('${record.sessionId}')">
                        <div class="history-item-header">
                            <span class="history-item-time">${timeStr}</span>
                            <span class="history-item-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="history-item-text">${record.text || '(æ— å†…å®¹)'}</div>
                    </div>
                `;
    }).join('');
  }

  function showHistoryDetail(sessionId) {
    const history = getHistory();
    const record = history.find(r => r.sessionId === sessionId);
    if (record) {
      displayResult(record.text);
    }
  }

  // é”™è¯¯å¤„ç†
  function showError(message) {
    if (errorMessage) {
      errorMessage.textContent = 'âŒ ' + message;
      errorMessage.classList.add('show');
      setTimeout(() => {
        hideError();
      }, 5000);
    } else {
      console.error('é”™è¯¯æ¶ˆæ¯:', message);
    }
  }

  function hideError() {
    if (errorMessage) {
      errorMessage.classList.remove('show');
    }
  }

  // æ·»åŠ å…¨å±€å‡½æ•°ä¾›å†å²è®°å½•ç‚¹å‡»ä½¿ç”¨
  window.showHistoryDetail = showHistoryDetail;

  // æ·»åŠ å…¨å±€é”™è¯¯æ•è·
  window.addEventListener('error', function(event) {
    console.error('JavaScripté”™è¯¯:', event.message, 'åœ¨:', event.filename, 'ç¬¬', event.lineno, 'è¡Œ');
  });
</script>
</body>
</html>