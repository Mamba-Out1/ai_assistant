<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…å†æ€»ç»“æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .test-btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-btn:hover { background: #0056b3; }
        .result { margin: 15px 0; padding: 15px; border-radius: 5px; min-height: 50px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #cce7ff; color: #004085; border: 1px solid #b3d7ff; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ ç—…å†æ€»ç»“åŠŸèƒ½æµ‹è¯•</h1>
        
        <!-- æµ‹è¯•1ï¼šè§£æDifyå“åº” -->
        <div class="test-section">
            <h3>æµ‹è¯•1ï¼šè§£æDify APIå“åº”</h3>
            <p>æµ‹è¯•è§£æä½ æä¾›çš„Dify APIå“åº”æ•°æ®</p>
            <button class="test-btn" onclick="testDifyResponse()">æµ‹è¯•Difyå“åº”è§£æ</button>
            <div id="test1-result" class="result info">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <!-- æµ‹è¯•2ï¼šè‡ªå®šä¹‰JSONè§£æ -->
        <div class="test-section">
            <h3>æµ‹è¯•2ï¼šè‡ªå®šä¹‰JSONè§£æ</h3>
            <p>è¾“å…¥è‡ªå®šä¹‰çš„ç—…å†æ€»ç»“JSONè¿›è¡Œè§£ææµ‹è¯•</p>
            <textarea id="customJson" placeholder="è¾“å…¥JSONæ•°æ®...">
{
  "properties": {
    "symptom_details": {
      "description": "æ‚£è€…ä¸»è¯‰å’½ç—›ï¼Œå§‹äºå‰å¤©æ™šä¸Šï¼ˆæœ€åˆä¸ºå’½å¹²ï¼‰ï¼Œæ˜¨å¤©åŠ é‡ã€‚ä¼´å‘çƒ­ï¼Œæœ€é«˜ä½“æ¸©38.5â„ƒï¼ˆæ˜¨æ—¥è‡ªæµ‹ï¼‰ï¼Œä»Šæ™¨37.8â„ƒã€‚ä¼´å…¨èº«ä¹åŠ›ã€‚ä¼´éšç—‡çŠ¶åŒ…æ‹¬å¹²å’³ï¼ˆç—°å°‘ï¼‰ã€é¼»å¡ã€æµæ¸…æ¶•ã€å¤´ç—›åŠå…¨èº«å…³èŠ‚é…¸ç—›ã€‚é£Ÿæ¬²å› å’½ç—›åå’½å›°éš¾è€Œå·®ï¼Œç¡çœ å› é¼»å¡å—å½±å“ï¼ŒäºŒä¾¿æ­£å¸¸ã€‚"
    },
    "vital_signs": {
      "description": "ä½“æ ¼æ£€æŸ¥ç¤ºå’½éƒ¨å……è¡€æ˜æ˜¾ï¼Œæ‰æ¡ƒä½“è‚¿å¤§ã€‚å¿ƒè‚ºå¬è¯Šæœªé—»åŠå¼‚å¸¸ã€‚ä½“æ¸©ç›‘æµ‹æ˜¾ç¤ºå‘çƒ­è¿‡ç¨‹ï¼ˆè§ç—‡çŠ¶è¯¦æƒ…ï¼‰ã€‚"
    },
    "past_medical_history": {
      "description": "æ‚£è€…å¹³ç´ ä½“å¥ï¼Œæœ‰è¿‡æ•æ€§é¼»ç‚ç—…å²ï¼ˆç§‹å­£æ˜“å‘ä½œï¼‰ã€‚æ— è¯ç‰©è¿‡æ•å²ã€‚"
    },
    "current_medications": {
      "description": "æ˜¨æ—¥æ›¾è‡ªè¡Œæœç”¨å¸ƒæ´›èŠ¬ä¸€ç‰‡é€€çƒ­ï¼Œä½“æ¸©å¯æš‚æ—¶ä¸‹é™ä½†ä¼šå†æ¬¡å‡é«˜ã€‚"
    }
  }
}
            </textarea>
            <br>
            <button class="test-btn" onclick="testCustomJson()">è§£æè‡ªå®šä¹‰JSON</button>
            <div id="test2-result" class="result info">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <!-- æµ‹è¯•3ï¼šä¿å­˜ç—…å†æ€»ç»“ -->
        <div class="test-section">
            <h3>æµ‹è¯•3ï¼šä¿å­˜ç—…å†æ€»ç»“åˆ°æ•°æ®åº“</h3>
            <p>æµ‹è¯•å°†è§£æåçš„ç—…å†æ€»ç»“ä¿å­˜åˆ°æ•°æ®åº“</p>
            <button class="test-btn" onclick="testSaveSummary()">ä¿å­˜æµ‹è¯•æ•°æ®</button>
            <div id="test3-result" class="result info">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <!-- æµ‹è¯•4ï¼šå®Œæ•´æµç¨‹æµ‹è¯• -->
        <div class="test-section">
            <h3>æµ‹è¯•4ï¼šå®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <p>æµ‹è¯•å®Œæ•´çš„ç—…å†æ€»ç»“ç”Ÿæˆæµç¨‹</p>
            <input type="text" id="testVisitId" placeholder="è¾“å…¥visitId" value="test_visit_001" style="padding: 8px; margin-right: 10px;">
            <button class="test-btn" onclick="testFullProcess()">å®Œæ•´æµç¨‹æµ‹è¯•</button>
            <div id="test4-result" class="result info">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        // æµ‹è¯•1ï¼šè§£æDifyå“åº”
        async function testDifyResponse() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•...';

            // æ¨¡æ‹Ÿä½ æä¾›çš„Dify APIå“åº”æ•°æ®
            const difyResponse = `{
  "properties": {
    "symptom_details": {
      "description": "æ‚£è€…ä¸»è¯‰å’½ç—›ï¼Œå§‹äºå‰å¤©æ™šä¸Šï¼ˆæœ€åˆä¸ºå’½å¹²ï¼‰ï¼Œæ˜¨å¤©åŠ é‡ã€‚ä¼´å‘çƒ­ï¼Œæœ€é«˜ä½“æ¸©38.5â„ƒï¼ˆæ˜¨æ—¥è‡ªæµ‹ï¼‰ï¼Œä»Šæ™¨37.8â„ƒã€‚ä¼´å…¨èº«ä¹åŠ›ã€‚ä¼´éšç—‡çŠ¶åŒ…æ‹¬å¹²å’³ï¼ˆç—°å°‘ï¼‰ã€é¼»å¡ã€æµæ¸…æ¶•ã€å¤´ç—›åŠå…¨èº«å…³èŠ‚é…¸ç—›ã€‚é£Ÿæ¬²å› å’½ç—›åå’½å›°éš¾è€Œå·®ï¼Œç¡çœ å› é¼»å¡å—å½±å“ï¼ŒäºŒä¾¿æ­£å¸¸ã€‚"
    },
    "vital_signs": {
      "description": "ä½“æ ¼æ£€æŸ¥ç¤ºå’½éƒ¨å……è¡€æ˜æ˜¾ï¼Œæ‰æ¡ƒä½“è‚¿å¤§ã€‚å¿ƒè‚ºå¬è¯Šæœªé—»åŠå¼‚å¸¸ã€‚ä½“æ¸©ç›‘æµ‹æ˜¾ç¤ºå‘çƒ­è¿‡ç¨‹ï¼ˆè§ç—‡çŠ¶è¯¦æƒ…ï¼‰ã€‚"
    },
    "past_medical_history": {
      "description": "æ‚£è€…å¹³ç´ ä½“å¥ï¼Œæœ‰è¿‡æ•æ€§é¼»ç‚ç—…å²ï¼ˆç§‹å­£æ˜“å‘ä½œï¼‰ã€‚æ— è¯ç‰©è¿‡æ•å²ã€‚"
    },
    "current_medications": {
      "description": "æ˜¨æ—¥æ›¾è‡ªè¡Œæœç”¨å¸ƒæ´›èŠ¬ä¸€ç‰‡é€€çƒ­ï¼Œä½“æ¸©å¯æš‚æ—¶ä¸‹é™ä½†ä¼šå†æ¬¡å‡é«˜ã€‚"
    }
  }
}`;

            try {
                const response = await fetch('/api/test/parse-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ jsonData: difyResponse })
                });

                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>âœ… è§£ææˆåŠŸï¼</strong><br>
                        <pre>${JSON.stringify(data.summary, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ è§£æå¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•2ï¼šè‡ªå®šä¹‰JSONè§£æ
        async function testCustomJson() {
            const resultDiv = document.getElementById('test2-result');
            const customJson = document.getElementById('customJson').value;
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨è§£æ...';

            try {
                const response = await fetch('/api/test/parse-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ jsonData: customJson })
                });

                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>âœ… è§£ææˆåŠŸï¼</strong><br>
                        <pre>${JSON.stringify(data.summary, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ è§£æå¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•3ï¼šä¿å­˜ç—…å†æ€»ç»“
        async function testSaveSummary() {
            const resultDiv = document.getElementById('test3-result');
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ä¿å­˜...';

            const testSummary = {
                visitId: 'test_visit_' + Date.now(),
                doctorId: 'test_doctor_001',
                patientId: 'test_patient_001',
                symptomDetails: 'æµ‹è¯•ç—‡çŠ¶è¯¦æƒ…ï¼šæ‚£è€…ä¸»è¯‰å’½ç—›ï¼Œä¼´å‘çƒ­',
                vitalSigns: 'æµ‹è¯•ç”Ÿå‘½ä½“å¾ï¼šä½“æ¸©38.5â„ƒï¼Œå’½éƒ¨å……è¡€',
                pastMedicalHistory: 'æµ‹è¯•æ—¢å¾€ç—…å²ï¼šå¹³ç´ ä½“å¥',
                currentMedications: 'æµ‹è¯•å½“å‰ç”¨è¯ï¼šå¸ƒæ´›èŠ¬'
            };

            try {
                const response = await fetch('/api/test/save-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testSummary)
                });

                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… ä¿å­˜æˆåŠŸï¼visitId: ${testSummary.visitId}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ ä¿å­˜å¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•4ï¼šå®Œæ•´æµç¨‹æµ‹è¯•
        async function testFullProcess() {
            const resultDiv = document.getElementById('test4-result');
            const visitId = document.getElementById('testVisitId').value;
            
            if (!visitId) {
                alert('è¯·è¾“å…¥visitId');
                return;
            }

            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æµ‹è¯•å®Œæ•´æµç¨‹...';

            try {
                // 1. æ£€æŸ¥è½¬å½•è®°å½•
                resultDiv.innerHTML += '<br>1. æ£€æŸ¥è½¬å½•è®°å½•...';
                const transcriptResponse = await fetch(`/api/transcription/visit/${encodeURIComponent(visitId)}`);
                
                if (!transcriptResponse.ok) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ æœªæ‰¾åˆ°visitId=${visitId}çš„è½¬å½•è®°å½•ï¼Œè¯·å…ˆè¿›è¡Œè¯­éŸ³è½¬å½•`;
                    return;
                }

                // 2. ç”Ÿæˆç—…å†æ€»ç»“
                resultDiv.innerHTML += '<br>2. ç”Ÿæˆç—…å†æ€»ç»“...';
                const summaryUrl = `/api/medical-summary/generate/${encodeURIComponent(visitId)}?doctorId=test_doctor&patientId=test_patient`;
                
                const summaryResponse = await fetch(summaryUrl, {
                    method: 'POST',
                    headers: {
                        'Accept': 'text/event-stream'
                    }
                });

                if (!summaryResponse.ok) {
                    throw new Error(`HTTP ${summaryResponse.status}: ${summaryResponse.statusText}`);
                }

                const reader = summaryResponse.body.getReader();
                const decoder = new TextDecoder();
                let summaryContent = '';
                let jsonSummary = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));

                                if (data.event === 'completed') {
                                    if (jsonSummary && jsonSummary.properties) {
                                        // æ ¼å¼åŒ–æ˜¾ç¤ºJSONæ ¼å¼çš„ç—…å†æ€»ç»“
                                        let formattedSummary = '<strong>âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼</strong><br>';
                                        formattedSummary += `visitId: ${visitId}<br><br>`;
                                        formattedSummary += '<div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #ddd;">';
                                        
                                        if (jsonSummary.properties.symptom_details) {
                                            formattedSummary += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                                                <strong style="color: #007bff;">ğŸ” ç—‡çŠ¶è¯¦æƒ…</strong>
                                                <p style="margin: 8px 0; color: #333;">${jsonSummary.properties.symptom_details.description}</p>
                                            </div>`;
                                        }
                                        if (jsonSummary.properties.vital_signs) {
                                            formattedSummary += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                                                <strong style="color: #dc3545;">â¤ï¸ ç”Ÿå‘½ä½“å¾</strong>
                                                <p style="margin: 8px 0; color: #333;">${jsonSummary.properties.vital_signs.description}</p>
                                            </div>`;
                                        }
                                        if (jsonSummary.properties.past_medical_history) {
                                            formattedSummary += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                                                <strong style="color: #ffc107;">ğŸ“‹ æ—¢å¾€ç—…å²</strong>
                                                <p style="margin: 8px 0; color: #333;">${jsonSummary.properties.past_medical_history.description}</p>
                                            </div>`;
                                        }
                                        if (jsonSummary.properties.current_medications) {
                                            formattedSummary += `<div style="padding: 15px;">
                                                <strong style="color: #17a2b8;">ğŸ’Š å½“å‰ç”¨è¯</strong>
                                                <p style="margin: 8px 0; color: #333;">${jsonSummary.properties.current_medications.description}</p>
                                            </div>`;
                                        }
                                        
                                        formattedSummary += '</div>';
                                        resultDiv.className = 'result success';
                                        resultDiv.innerHTML = formattedSummary;
                                    } else {
                                        resultDiv.className = 'result success';
                                        resultDiv.innerHTML = `
                                            <strong>âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼</strong><br>
                                            visitId: ${visitId}<br>
                                            ç”Ÿæˆçš„ç—…å†æ€»ç»“ï¼š<br>
                                            <pre>${summaryContent}</pre>
                                        `;
                                    }
                                    return;
                                } else if (data.event === 'error') {
                                    resultDiv.className = 'result error';
                                    resultDiv.innerHTML = `âŒ ç”Ÿæˆå¤±è´¥: ${data.message}`;
                                    return;
                                } else if (data.event === 'message' && data.content) {
                                    // æ£€æŸ¥æ˜¯å¦æ˜¯JSONæ ¼å¼
                                    if (typeof data.content === 'object') {
                                        jsonSummary = data.content;
                                        summaryContent = JSON.stringify(data.content);
                                    } else if (typeof data.content === 'string' && data.content.trim().startsWith('{')) {
                                        try {
                                            jsonSummary = JSON.parse(data.content);
                                            summaryContent = data.content;
                                        } catch (e) {
                                            summaryContent += data.content;
                                        }
                                    } else {
                                        summaryContent += (typeof data.content === 'string' ? data.content : JSON.stringify(data.content));
                                    }
                                    resultDiv.innerHTML = `ğŸ”„ æ­£åœ¨ç”Ÿæˆ...<br><pre>${summaryContent.substring(0, 500)}</pre>`;
                                }
                            } catch (e) {
                                console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
    </script>
</body>
</html>